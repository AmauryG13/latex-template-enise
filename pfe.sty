\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pfe}

\newif\if@sommairechap \@sommairechaptrue
\DeclareOption{sommairechap}{\@sommairechaptrue}
\ProcessOptions
% ==========================================================================
% PACKAGES ADDITIONNELS

% Police MathPazo
\RequirePackage[osf,sc]{mathpazo}
\RequirePackage[scaled=.95]{helvet}
\RequirePackage{courier}
% Entêtes améliorés
\RequirePackage{fancyhdr}
% Enumerations personnalisée 
\RequirePackage{enumerate}
% Calcul des tailles d'environnement
\RequirePackage{calc}
% Symboles de amsmath et additionnels
\RequirePackage{amsmath,amsfonts,amssymb,amsthm}
\RequirePackage{dsfont,mathrsfs}
% Lettrine
\RequirePackage{lettrine}
% Ajout d'entrées dans la table des matières
\RequirePackage{tocbibind}
% Style de la légende
\RequirePackage{caption}
\DeclareCaptionLabelSeparator{mysep}{~--~}
\captionsetup{singlelinecheck=no,labelsep=mysep,font=small,textfont=it}
\setlength{\abovecaptionskip}{5pt}
\setlength{\belowcaptionskip}{-5pt}
% Tableaux sur plusieurs pages - page de notations
\RequirePackage{supertabular}
% Mise en forme des algorithmes
\RequirePackage[french,ruled,vlined]{algorithm2e}
% Gestion améliorée de la bibliographie
%\RequirePackage{natbib}
%\bibliographystyle{abbrv}
%\bibpunct{(}{)}{,}{a}{}{;}
% Gestion des iamges wrappes
\RequirePackage{wrapfig}
% Chargement de minitoc avant hyperref
\RequirePackage[french]{minitoc}
% Gestion des référence selon le format de sortie
\RequirePackage{ifpdf}
\ifpdf
% configuration de graphicx et hyperref pour sortie PDF
\RequirePackage[pdftex]{graphicx}
\RequirePackage[
pdftex,
bookmarksopen=false,
pdfauthor=Amaury Guillermin,
colorlinks=false,
pagebackref,
plainpages=false]{hyperref} 
\DeclareGraphicsExtensions{.pdf,.png,.jpg,.tif}
\else
% configuration de graphicx et hyperref pour sortie PS
\RequirePackage[dvips]{graphicx}
\DeclareGraphicsExtensions{.eps,.ps}
\RequirePackage[
dvips,
bookmarksopen=false,
pdfauthor=Amaury Guillermin,
colorlinks=false,
pagebackref,
plainpages=false]{hyperref}
\fi
\graphicspath{{./images/}}
% Gestion éventuel des sommaires en début de chapitre
\if@sommairechap
\dominitoc
\setlength{\mtcindent}{0em}
\renewcommand{\mtifont}{\large\rm\scshape}
\renewcommand{\mtcSfont}{\small\rm\scshape}
\fi
\RequirePackage{tocloft}
\renewcommand{\cftsubsecfont}{\small}
\renewcommand{\cftsecfont}{\normalsize\scshape}
\renewcommand{\cftchapfont}{\large\scshape}
\renewcommand{\cfttoctitlefont}{\Huge\scshape}
\renewcommand{\cftloftitlefont}{\Huge\scshape}

% CONFIGURATION DE LA CÉSURE
\tolerance = 1414
\hbadness = 1414
\emergencystretch 1.5em
\hfuzz 0.3pt
\widowpenalty=10000
\vfuzz \hfuzz
\raggedbottom

% =============================================
% PAGE DE GARDE
% Titre
\def\titleFR#1{\gdef\@titleFR{#1}}
\def\titleEN#1{\gdef\@titleEN{#1}}
\def\abstractFR#1{\gdef\@abstractFR{#1}}
\def\abstractEN#1{\gdef\@abstractEN{#1}}
\def\keywordsFR#1{\gdef\@keywordsFR{#1}}
\def\keywordsEN#1{\gdef\@keywordsEN{#1}}

% Type de document
\def\type{Rapport de Projet de Fin d'Études}
\def\id#1{\gdef \@id{#1}}
\def\@type{\type \space \MakeUppercase{\romannumeral \@id}}
\def\datedebut#1{\gdef\@debut{#1}}
\def\datefin#1{\gdef\@fin{#1}}

% Informations Auteur
\def\author#1{\gdef\@author{#1}}
\def\annee#1{\gdef\@annee{#1}}
\def\promotion#1{\gdef\@promotion{#1}}

% Université
\def\universite#1{\gdef\@universite{#1}}
\def\uadresse#1{\gdef\@uadresse{#1}}

% Partenaires
\def\partenaireNB#1{\gdef\@partenaireNB{#1}}

\def\laboratoire#1{\gdef\@laboratoire{#1}}
\def\ladresse#1{\gdef\@ladresse{#1}}
\def\lecole#1{\gdef\@lecole{#1}}
\def\lbat#1{\gdef\@lbat{#1}}

\def\entreprise#1{\gdef\@entreprise{#1}}
\def\esiege#1{\gdef\@esiege{#1}}
\def\eadresse#1{\gdef\@eadresse{#1}}

% Autres
\def\jury#1{\gdef\@jury{#1}}
\def\dedicate#1{\gdef\dedication@text{#1}}

\renewcommand{\titlepage}{%
	\begin{center}
		
		%% Entete
		\begin{minipage}[c]{8cm}
			\begin{flushleft}
				\includegraphics[width=1\textwidth]{couverture/universite} \\
			\end{flushleft}
		\end{minipage}
		\begin{minipage}[c]{8cm}
			\begin{flushright}
				\LARGE \@author \\
				\large \@annee \\
				\large \@promotion \\
			\end{flushright}
		\end{minipage}
		\vspace{\fill}
		
		\Large \@universite \\
		\large \@uadresse\\
		
		% Titre Centré
		\vspace{\fill}
		\large \@type \\
		\large \@debut \space au \@fin \\
		
		\Huge \textbf{\@titleFR} \\
		\vspace{\fill}
		
		\if@enise@industriel
		\begin{minipage}[c]{8cm}
			\begin{center}
				\includegraphics[width=0.6\textwidth]{couverture/entreprise} \\
			\end{center}
		\end{minipage}
		\vspace{0.5cm}
		
		\Large \@entreprise \\
		\small (\@esiege) \\
		\large \@eadresse \\  	
		\else
		\begin{minipage}[c]{8cm}
			\begin{center}
				\includegraphics[width=0.6\textwidth]{couverture/laboratoire} \\
			\end{center}
		\end{minipage}
		\vspace{0.5cm}
		
		\Large \@laboratoire \\
		\large \@lecole \\
		\large \@lbat \\
		\large \@ladresse \\
		\fi
		
		%
		\vfill    
		\begin{minipage}[c]{17cm}
			\begin{flushleft}
				\emph{Membres du Jury:}
				\\
				\@jury
			\end{flushleft}
		\end{minipage}
		
	\end{center}
	\cleardoublepage
}

% ===========================================================
% PAGE DE DEDICACE 
\newcommand{\dedicacepage}{% 
	\begin{flushright}
		\large\em\null\vskip1in\dedication@text\vfill
	\end{flushright}
	\cleardoublepage
}

\newcommand{\abstractpage}{%
	\pagestyle{empty}
	~\newpage
	\par
	\vfill
	
	\paragraph*{Titre}\@titleFR
	
	\paragraph*{Résumé}\@abstractFR
	
	\paragraph*{Mots-clés}\@keywordsFR
	
	\paragraph*{Title}\@titleEN
	
	\paragraph*{Abstract}\@abstractEN
	
	\paragraph*{Keywords}\@keywordsEN
}


% ==========================================================================
% MISE EN PAGE
\RequirePackage{geometry}
%\geometry{textheight=145ex,textwidth=33em,top=85pt,headheight=30pt,headsep=30pt,inner=120pt}
\geometry{top=2cm, bottom=2cm, left=2cm, right=2cm}
\addtolength{\marginparwidth}{-20pt}
\addtolength{\headwidth}{\marginparsep}
\addtolength{\headwidth}{\marginparwidth}

% ==========================================================================
% ENTÊTES
% Entêtes standards

\fancypagestyle{plain}{
	\fancyhf{}
	\fancyfoot[L]{\thepage}
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}
}

\fancypagestyle{main}{
	\fancyhf{}
	\fancyhead[LO]{\nouppercase{\rightmark}}
	\fancyfoot[LO]{\thepage}
	\fancyhead[RO,LE]{\thepage}
	\fancyhead[RE]{\nouppercase{\leftmark}}
	\fancyfoot[RE]{\thepage}
	\renewcommand{\headrulewidth}{0.5pt}
	\renewcommand{\footrulewidth}{0pt}
}

% ==============================================================
% PRÉFACE 
\newcommand{\beforepreface}{
	\frontmatter
	\pagestyle{empty}
	\titlepage
	\dedicacepage
	\pagestyle{plain}
}

% ==============================================================
% CONTENU MAÎTRE
\newcommand{\afterpreface}{
	\mainmatter
	\pagestyle{main}
}

% ---------------------------------------------------------------
% PERSONNALISATION DE BABEL
% redéfinition des noms chapitres spéciaux
\addto{\captionsfrench}{
	\renewcommand*{\listfigurename}{Liste des figures}
	\renewcommand*{\appendixname}{}%
}
% noindent en début de section
%\addto\extrasfrench{\bbl@nonfrenchindent}

% ==========================================================================
% PAGE DE GARDE DES CHAPITRES
% Le résumé + le minitoc éventuel
\newenvironment{chapintro}{%
	\if@sommairechap \nomtcrule \vspace{1.5cm} \minitoc[l] \fi}{%
	\cleardoublepage
}

% chapitre numéroté
\newfont{\chapterNumber}{eurb10 scaled 7000}
\renewcommand*{\@makechapterhead}[1]{%
	\thispagestyle{plain}
	\marginpar{\vspace*{1.5em}\flushright\chapterNumber\thechapter}
	\begin{flushleft}\nobreak\Huge\sc#1\end{flushleft}
	\vspace{3cm}
}
% chapitre non numéroté (*) 
\renewcommand*{\@makeschapterhead}[1]{%  
	\markboth{#1}{#1}
	\thispagestyle{plain}
	\begin{flushleft}\nobreak\Huge\sc #1\end{flushleft}
	\vspace{3cm}
	\if@sommairechap \mtcaddchapter \fi
}

% ==========================================================================
% LES SECTIONS, SOUS-SECTIONS, SOUS-SOUS-SECTIONS
\makeatletter
\renewcommand\section{\@startsection {section}{1}{\z@}%
	{-3.5ex \@plus -1ex \@minus -.2ex}%
	{2.3ex \@plus.2ex}%
	{\normalfont\Large\scshape}}
\renewcommand{\subsection}{\@startsection{subsection}{2}{\z@}%
	{-3.25ex\@plus -1ex \@minus -.2ex}%
	{1.5ex \@plus .2ex}%
	{\normalfont\bfseries\large}}

\def\@seccntformat#1{%
	\protect\makebox[-3.5pt][r]{\csname the#1\endcsname\quad\hspace{-3.5pt}}
}
\makeatother

% ==========================================================================
% ANNEXE, BIBLIOGRAPHIE

% Annexe se comportez comme un chapitre
\let\oldappendix=\appendix
\renewcommand\appendix{
	\oldappendix
	\chapter{Annexes}
	\thispagestyle{plain}
	\begin{chapintro} \end{chapintro}
	\pagestyle{main}
}

\RequirePackage[hyperpageref]{backref}
\backreffrench
\renewcommand*{\backref}[1]{}  % Disable standard
\renewcommand*{\backrefalt}[4]{% Detailed backref
	\ifcase #1 %
	\relax%(Not cited.)%
	\or
	(Cit\'e page~#2.)%
	\else
	(Cit\'e pages~#2.) 
	\fi}

% Page blanche après chapitre si nécessaire
\makeatletter
\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else
	\hbox{}
	\vspace*{\fill}
	\begin{center}
		~
	\end{center}
	\vspace{\fill}
	\thispagestyle{empty}
	\newpage
	\if@twocolumn\hbox{}\newpage\fi\fi\fi}
\makeatother

% ---------------------------------------------------------------
% LETTRINE
\newcommand{\malettrine}[1]{
	\lettrine[lines=2,lhang=0.33,loversize=0.33]{#1}
}

% ---------------------------------------------------------------
% THEOREMES
\newlength{\thmmargin}
\newlength{\thmmargina}
\newlength{\thmmarginb}
\newlength{\thmmarginc}
\newlength{\thmmargind}
\newlength{\thmmargine}
\newlength{\thmmarginf}
\newlength{\thmmarging}
\newlength{\thmmarginh}

\addtolength{\thmmargin}{105pt}
\addtolength{\thmmarginb}{\thmmargin-7.85ex} % exemple -- ok
\addtolength{\thmmarginc}{\thmmargin-6.1ex} %  théorème,remarque -- ok
\addtolength{\thmmargind}{\thmmargin-7.4ex} % propriété -- ok
\addtolength{\thmmargine}{\thmmargin-6ex} % définition -- ok
\addtolength{\thmmargina}{\thmmargin-5.625ex} % hypothèse -- ok
\addtolength{\thmmarginf}{\thmmargin-4.8ex} % proposition -- ok
\addtolength{\thmmarging}{\thmmargin-8.7ex} % Lemme -- ok
\addtolength{\thmmarginh}{\thmmargin-6.5ex} % Corollaire -- ok

% COMMAND \newtheoremstyle
% espace avant, espace après, font du corps, retrait titre, font titre, ponctuaiton après titre, espace intermot, option supp

% hypothèse
\newtheoremstyle{thma}{9pt}{9pt}{\itshape}{-\thmmargina}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thma}
\newtheorem{hypothese}{Hypoth\`{e}se}[chapter]
% exemple
\newtheoremstyle{thmb}{9pt}{9pt}{\itshape}{-\thmmarginb}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thmb}
\newtheorem{exemple}{Exemple}[chapter]
% théorème & remarque
\newtheoremstyle{thmc}{9pt}{9pt}{\itshape}{-\thmmarginc}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thmc}
\newtheorem{theoreme}{Th\'{e}or\`{e}me}[chapter]
\newtheorem{remarque}{Remarque}[chapter]
% propriété
\newtheoremstyle{thmd}{9pt}{9pt}{\itshape}{-\thmmargind}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thmd}
\newtheorem{propriete}{Propri\'{e}t\'{e}}[chapter]
% définition
\newtheoremstyle{thme}{9pt}{9pt}{\itshape}{-\thmmargine}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thme}
\newtheorem{definitionf}{D\'{e}finition}[chapter]
% proposition
\newtheoremstyle{thmf}{9pt}{9pt}{\itshape}{-\thmmarginf}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thmf}
\newtheorem{propositionf}{Proposition}[chapter]
% lemme
\newtheoremstyle{thmg}{9pt}{9pt}{\itshape}{-\thmmarging}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thmg}
\newtheorem{lemme}{Lemme}[chapter]
% corollaire
\newtheoremstyle{thmh}{9pt}{9pt}{\itshape}{-\thmmarginh}{\small\bfseries}{\quad}{ }{}
\theoremstyle{thmh}
\newtheorem{corollaire}{Corollaire}[chapter]


% ==========================================================================
% FIGURES ET TABLES 

% \figScale{monfichier}{Légende de la figure}
\newcommand{\figScaleX}[4]{
	\begin{figure}[htp!]
		\begin{#4}
			\includegraphics[width=#1\textwidth]{./figures/#2}
			\caption{#3}
			\label{fig:#2}
		\end{#4}
	\end{figure}
}
\newcommand{\figScale}[4]{
	\figScaleX{#1}{#2}{#3}{#4}
}
\newcommand{\figScaleRot}[3]{
	\begin{figure}[htp!]
		\includegraphics[angle=#1,width=0.95\textwidth]{./figures/#2}
		\caption{#3}
		\label{fig:#2}
	\end{figure}
}

% ==========================================================================
% COLOPHON
\newcommand{\colophon}[1]{
	~\vfill
	\begin{center}
		\small #1
	\end{center}
	\cleardoublepage
}
